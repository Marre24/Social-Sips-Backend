pipeline {
    agent any

    environment {
        DEPLOY_DIR = "/opt/app-config/jwt"
        PRIVATE_KEY_CRED = 'jwt-private-key'  // Jenkins Secret File ID
        PUBLIC_KEY_CRED = 'jwt-public-key'    // Jenkins Secret File ID
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build Spring Boot App') {
            steps {
                sh './mvnw clean package'
            }
        }

        stage('Deploy JWT Keys') {
            steps {
                withCredentials([
                    file(credentialsId: "${PRIVATE_KEY_CRED}", variable: 'PRIVATE_KEY'),
                    file(credentialsId: "${PUBLIC_KEY_CRED}", variable: 'PUBLIC_KEY')
                ]) {
                    sh """
                        sudo mkdir -p ${DEPLOY_DIR}
                        sudo cp $PRIVATE_KEY ${DEPLOY_DIR}/private.pem
                        sudo cp $PUBLIC_KEY ${DEPLOY_DIR}/public.pem
                        sudo chown tomcat:tomcat ${DEPLOY_DIR}/*.pem
                        sudo chmod 640 ${DEPLOY_DIR}/*.pem
                    """
                }
            }
        }
    }
}